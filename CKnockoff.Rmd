---
title: "Conditional Knockoff"
output: html_document
---

This R notebook illustrate the method of conditional knockoffs in Section 3 of the accompanying paper. 
```{r message=FALSE}
library(knockoff)
source('knockoff_measure.R')
source('util.R')
```
## Multivariate Gaussian Models (Section 3.1)
In this scenario we assume that the distribution of the covariate belongs to a multivariate Gaussian family with unknown mean and covariance matrix, and we make no assumptions on the conditional distribution of the response. For simplicity, we will use synthetic data constructed from a linear model such that the response only depends on a small fraction of the variables. We will separately look at the cases where the number of observations $n$ is greater than 2 times the dimension ($2p$) and where $n<p$ but unlabelled data are available.

### Low-Dimensional
We first setup the experiment with $n>2p$. 
```{r message=FALSE,cache=T}
set.seed(2019)
source('cknock_ldg.R')
# Problem parameters
p=400
n=3*p
k=60
A=5
nonzero = sample(p, k) 
beta = 1  * (1:p %in% nonzero) * sample(c(-1,1),p,rep=T) 
# Generate the variables from a multivariate normal distribution 
rho=0.3
Sigma=rho^abs(outer(1:p,1:p,'-'))
Sigma.chol = chol(Sigma)
X = matrix(rnorm(n * p), n)  %*% Sigma.chol

# Generate the response from a linear model
Y=X%*%beta*A/sqrt(n) + rnorm(n)
```

The conditional kncokfoff can be generated by calling the function \textit{cknockoff.ldg} where the method option refers to how the $\mathbf{s}$ is computed. 
```{r message=FALSE,cache=T}
Xk.cond=cknockoff.ldg(X,method = 'mix')
```
Then it is routinely used by knockoff filter to select variables. 

```{r message=FALSE,warning=FALSE,cache=T}
fdr.level = 0.2
knockoff.stat.fun =  mod.stat.lasso_coefdiff
filter.cond=knockoff.filter(X,Y,
        knockoffs = function(x) {
          Xk.cond
        },
        statistic = knockoff.stat.fun,
        fdr = fdr.level,offset = 1)
# false positive and false negative
c(fp(filter.cond$selected, beta),
  fn(filter.cond$selected, beta))
```

### High-Dimensional with Unlabled Data
In this example, we setup the experiments with a small sample size ($n<2p$) and with additional unlabelled data such that the total number of covariate data are more than $2p$.
```{r message=FALSE,cache=T}
# Problem parameters
n=300
n.u=2*p
# Generate labelled and unlabelled covariate
X = matrix(rnorm(n * p), n)  %*% Sigma.chol
X.u = matrix(rnorm(n.u * p), n.u)  %*% Sigma.chol

# Generate the response from a linear model
Y=X%*%beta*A/sqrt(n) + rnorm(n)
```

We can generate the low-dimensional conditional knockoff for all the covariates and take out the corresponding rows for the labelled data. 
```{r message=FALSE,cache=T}
Xk.star=cknockoff.ldg(rbind(X,X.u),method = 'mix')
Xk.cond=Xk.star[1:n,]
```

```{r message=FALSE,warning=FALSE,cache=T}
filter.cond=knockoff.filter(X,Y,
        knockoffs = function(x) {
          Xk.cond
        },
        statistic = knockoff.stat.fun,
        fdr = fdr.level,offset = 1)
# false positive and false negative
c(fp(filter.cond$selected, beta),
  fn(filter.cond$selected, beta))
```


## High-Dimensional Gaussian Graphical Models


